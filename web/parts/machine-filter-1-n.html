<!-- Machine Filter 1 to N Start-->
<div class="magic-name" id="magic-name-machine-filter-{{index}}">
    <i class="icon-check-empty icon-large"></i>{{title}}
</div>
<div class="magic-mirror" id="magic-mirror-machine-filter-{{index}}">
    <table id="machines-{{index}}"></table>
    <a href="javascript:void(0);" id="button-machine-filter-{{index}}" class="button">Enter</a>
</div>
<script type="text/javascript">
    iframe_register(function () {

        var chks_master = {};
        var chks_slave = {};

        Toolkits.async_get("{{url}}", {}, function (xmlhttp, data) {
            if (!data) {
                return;
            }
            var d = Toolkits.toJson(data);
            var box = document.getElementById('machines-{{index}}');
            var tr = document.createElement('tr');
            var th = document.createElement('th');
            th.textContent = 'master';
            tr.appendChild(th);
            var th2 = document.createElement('th');
            th2.textContent = 'slave';
            tr.appendChild(th2);
            for (var _ in d.columns) {
                if (d.columns[_] != 'id') {
                    var th = document.createElement('th');
                    th.textContent = d.columns[_];
                    tr.appendChild(th);
                }
            }
            box.appendChild(tr);
            for (var _ in d.rows) {
                var tr = document.createElement('tr');

                (function (i) {
                    var td = document.createElement('td');
                    var chk = document.createElement('input');
                    chk.type = 'checkbox';
                    chk.onclick = function (e) {
                        var b = !!e.srcElement.checked;
                        for (var n in chks_master) {
                            chks_master[n]['b'] = false;
                            chks_master[n]['e'].checked = false;
                        }
                        e.srcElement.checked = b;
                        chks_master[i] = { 'b': b, 'e': e.srcElement };
                    }
                    td.appendChild(chk);
                    tr.appendChild(td);
                })(d.rows[_]['id']);

                (function (i) {
                    var td = document.createElement('td');
                    var chk = document.createElement('input');
                    chk.type = 'checkbox';
                    chk.onclick = function (e) {
                        var b = !!e.srcElement.checked;
                        e.srcElement.checked = b;
                        chks_slave[i] = { 'b': b, 'e': e.srcElement };
                    }
                    td.appendChild(chk);
                    tr.appendChild(td);
                })(d.rows[_]['id']);

                for (var _1 in d.columns) {
                    if (d.columns[_1] != 'id') {
                        var val = d.rows[_][d.columns[_1]];
                        var td = document.createElement('td');
                        td.textContent = val;
                        tr.appendChild(td);
                    }
                }
                box.appendChild(tr);
            }
        });

        var button_machine_filter = document.getElementById('button-machine-filter-{{index}}');

        var m = new Magic('machine-filter-{{index}}', '{{wizardName}}', ___index___, function (magic, mana) {
            if (!mana) {
                mana = {}
            }
            for (var _ in chks_master) {
                if (chks_master[_]['b']) {
                    mana['master'] = _;
                }
            }
            var slaves = [];
            for (var _ in chks_slave) {
                if (chks_slave[_]['b']) {
                    slaves.push(_);
                }
            }
            mana['slaves'] = slaves;
            return mana;
        });
        Magician.practice(m);

        button_machine_filter.addEventListener('click', function (e) {
            m.ready = true; // if not zero
            var i = document.getElementById('magic-name-machine-filter-{{index}}').getElementsByTagName('i')[0];
            i.classList.remove('icon-check-empty');
            i.classList.add('icon-check');
            Magician.fire('{{wizardName}}', null);
        });
    });
</script>
<!-- Machine Filter 1 to N End-->
