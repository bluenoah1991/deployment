<!-- Machine Filter Start-->
<div class="magic-name" id="magic-name-machine-filter-{{index}}">
    <i class="icon-check-empty icon-large"></i>{{title}}
</div>
<div class="magic-mirror" id="magic-mirror-machine-filter-{{index}}">
    <table id="machines-{{index}}"></table>
    <a href="javascript:void(0);" id="button-machine-filter-{{index}}" class="button">Enter</a>
</div>
<script type="text/javascript">
    iframe_register(function () {

        var chks = {};
        var mselect = '{{mselect}}';

        Toolkits.async_get("{{url}}", {}, function (xmlhttp, data) {
            if (!data) {
                return;
            }
            var d = Toolkits.toJson(data);
            var box = document.getElementById('machines-{{index}}');
            var tr = document.createElement('tr');
            for (var _ in d.columns) {
                var th = document.createElement('th');
                if (d.columns[_] == 'id') {
                    th.textContent = '';
                } else {
                    th.textContent = d.columns[_];
                }
                tr.appendChild(th);
            }
            box.appendChild(tr);
            for (var _ in d.rows) {
                var tr = document.createElement('tr');
                for (var _1 in d.columns) {
                    if (d.columns[_1] == 'id') {
                        var td = document.createElement('td');
                        var chk = document.createElement('input');
                        chk.type = 'checkbox';
                        (function (i) {
                            chk.onclick = function (e) {
                                var b = !!e.srcElement.checked;
                                if (mselect == 'off') {
                                    for (var n in chks) {
                                        chks[n]['b'] = false;
                                        chks[n]['e'].checked = false;
                                    }
                                }
                                e.srcElement.checked = b;
                                chks[i] = { 'b': b, 'e': e.srcElement };
                            }
                        })(d.rows[_]['id']);
                        td.appendChild(chk);
                        tr.appendChild(td);
                        continue;
                    }
                    var val = d.rows[_][d.columns[_1]];
                    var td = document.createElement('td');
                    td.textContent = val;
                    tr.appendChild(td);
                }
                box.appendChild(tr);
            }
        });

        var button_machine_filter = document.getElementById('button-machine-filter-{{index}}');

        var m = new Magic('machine-filter-{{index}}', '{{wizardName}}', ___index___, function (magic, mana) {
            if (!mana) {
                mana = {}
            }
            var result = [];
            for (var _ in chks) {
                if (chks[_]['b']) {
                    result.push(_);
                }
            }
            mana['{{fieldName}}'] = result;
            return mana;
        });
        Magician.practice(m);

        button_machine_filter.addEventListener('click', function (e) {
            m.ready = true; // if not zero
            var i = document.getElementById('magic-name-machine-filter-{{index}}').getElementsByTagName('i')[0];
            i.classList.remove('icon-check-empty');
            i.classList.add('icon-check');
            Magician.fire('{{wizardName}}', null);
        });
    });
</script>
<!-- Machine Filter End-->
